<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>bash&expect</title>
</head>
<body>
    <h2>脚本1：检查各主机的mount分区使用率</h2>
#!/bin/bash

function _expect(){
	local IP=$1
	local USER=$2
	local PASSWD=$3
	local SOURE_IP=$4
	local PASSWD1=$5
	expect <<-EOF &>/dev/null
	spawn ssh $USER@$IP
	expect {
		"yes/no" { send "yes\r"; exp_continue }
		"*assword:" { send "$PASSWD\r" };
	}
	set timeout 2
	expect -re "#|>"
	send "df -h | awk 'BEGIN{ORS=\";\"; printf \"\'\"$IP\"\'\"\",\"} (\\\$1!~/.*loop\[0-9\]/) && (int(\\\$(NF-1))>=90){print \\\$NF\":\"\\\$(NF-1)} END{printf \"\\\n\"}' | ssh root@$SOURE_IP 'cat - >> ${_PATH}/log/check_${_file}.csv'\r"
	expect {
                "yes/no" { send "yes\r"; exp_continue }
                "*assword:" { send "$PASSWD1\r" };
        }
	send "exit\r"
	expect eof
	EOF
}

function main(){
	export _PATH=`pwd`
	if [[ ! -d ${_PATH}/log ]]; then
		mkdir ${_PATH}/log
	fi
	soure_ip=`ip a s bond1 | grep "\<inet\>" | awk 'BEGIN{FS="[ /]+"} {print $3}'`
	_file=`date +%Y%m%d%H%M%S`
	thread=${1:-10}
	read -s -p "Please enter the local user password to facilitate remote component transfer log to the machine:" soure_password
	echo
        tmp_fifofile=/tmp/$$.fifo
        mkfifo $tmp_fifofile
        exec 8<> $tmp_fifofile
        rm $tmp_fifofile
	first=0
        for i in `seq $thread`; do
                echo >&8
        done
	for list in `cat Clients.csv`; do
        	if [[ $first == 0 ]]; then
                	first=1 
			continue
        	fi
		ip=`echo $list | awk -F"," '{print $1}'`
                user=`echo $list | awk -F"," '{print $2}'`
                password=`echo $list | awk -F"," '{print $3}'`
		read -u 8
		{
		_expect $ip $user ${password} $soure_ip $soure_password
		echo "$ip checked"
		echo >&8
		}&
	done
	wait
        exec 8>&-
	if [[ -f ${_PATH}/log/check_${_file}.csv ]]; then
		echo "finished"
	else
		echo "Execution failed, the local password may be wrong, please check"
	fi

}

main $1 
    
 <h2>脚本2：检查主机是否能ssh登录</h2>
<p>#/usr/bin/env bash</p>

<p>if [[ -f Clients.csv ]]; then</p>
	<p>thread=${1:-10}</p>
	<p>tmp_fifofile=/tmp/$$.fifo</p>
	<p>mkfifo $tmp_fifofile</p>
	<p>exec 8<> $tmp_fifofile</p>
	<p>rm $tmp_fifofile</p>
	<p>for i in `seq $thread`; do</p>
		<p>echo >&8</p>
	<p>done</p>
        <p>>login.log</p>
	<p>i=0</p>
	<p>for list in $(cat Clients.csv); do</p>
	<p>if [[ $i == 0 ]]; then</p>
		<p>i=1</p>
		<p>continue</p>
	<p>fi</p>
	<p>ip=`echo $list | awk -F"," '{print $1}'`</p>
        <p>user=`echo $list | awk -F"," '{print $2}'`</p>
        <p>password=`echo $list | awk -F"," '{print $3}'`</p>
	<p>read -u 8</p>
	<p>{</p>
	<p>/usr/bin/expect >/dev/null 2>&1 <<-EOF</p>
	
	<p>spawn ssh ${user}@${ip}</p>
	<p>set timeout 3</p>
	<p>expect {</p>
		<p>-re "yes/no" { send "yes\r"; exp_continue }</p>
		<p>-re ".*assword:" { send "${password}\r" };</p>
	<p>}</p>
	<p>expect -re "\[#>]" { send "exit\r" }</p>
	<p>expect {</p>
		<p>timeout { exit 1 }</p>
		<p>eof { exit 0 }</p>
	<p>}</p>
	<p>EOF</p>
<p>#	echo $?</p>
	<p>if [[ $? -eq 0 ]]; then</p>
		<p>printf "%-15s -------------------- ok\n" $ip  | tee -a  login.log</p>
	<p>else</p>
		<p>printf "%-15s -------------------- falied\n" $ip | tee -a login.log</p>
	<p>fi</p>
	<p>echo >&8</p>
	<p>}&</p>
	<p>done</p>
	<p>wait</p>
	<p>exec 8>&-</p>
	<p>echo "finishi..."</p>
<p>fi</p>
</body>
</html>
